<!doctype html><html lang=tr><head><title>Legacy WCF/SOAP'tan Modern .NET'e: Taviz Vermeden Migration :: Berk Selvi | Software Developer</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Eski .NET Framework WCF/SOAP uygulamalarını, mevcut SOAP entegrasyonlarını bozmadan modern .NET'e nasıl taşıyacağınızı keşfedin. Bu rehber, SOAP kontratlarınızı korurken modern geliştirme pratiklerini benimsemek ve tüm paydaşlar için sorunsuz bir geçiş sağlamak adına CoreWCF kullanımına dair pratik desenler sunmaktadır."><meta name=keywords content=".NET,CoreWCF,SOAP,WCF,migration,eski sistemler,modernizasyon"><meta name=robots content="noodp"><link rel=canonical href=https://berkselvi.dev/tr/posts/legacy-wcf-soap-to-modern-dotnet-migration/><link rel=stylesheet href=https://berkselvi.dev/assets/style.css><link rel=stylesheet href=https://berkselvi.dev/assets/green.css><link rel=canonical href=https://berkselvi.dev/tr/posts/legacy-wcf-soap-to-modern-dotnet-migration/><link rel=apple-touch-icon sizes=57x57 href=/icon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/icon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/icon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/icon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/icon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/icon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/icon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/icon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/icon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/icon/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/icon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/icon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/icon/favicon-16x16.png><link rel=manifest href=/icon/manifest.json><meta name=msapplication-TileColor content="#1D1E28"><meta name=msapplication-TileImage content="/icon/ms-icon-144x144.png"><meta name=theme-color content="#1D1E28"><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="berkslv"><meta property="og:locale" content="tr"><meta property="og:type" content="article"><meta property="og:title" content="Legacy WCF/SOAP'tan Modern .NET'e: Taviz Vermeden Migration"><meta property="og:description" content="Eski .NET Framework WCF/SOAP uygulamalarını, mevcut SOAP entegrasyonlarını bozmadan modern .NET'e nasıl taşıyacağınızı keşfedin. Bu rehber, SOAP kontratlarınızı korurken modern geliştirme pratiklerini benimsemek ve tüm paydaşlar için sorunsuz bir geçiş sağlamak adına CoreWCF kullanımına dair pratik desenler sunmaktadır."><meta property="og:url" content="https://berkselvi.dev/tr/posts/legacy-wcf-soap-to-modern-dotnet-migration/"><meta property="og:site_name" content="Berk Selvi | Software Developer"><meta property="og:image" content="https://berkselvi.dev/img/legacy-wcf-soap-to-modern-dotnet-migration/cover.webp"><meta property="twitter:image" content="https://berkselvi.dev/img/legacy-wcf-soap-to-modern-dotnet-migration/cover.webp"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2025-12-12 00:00:00 +0300 +0300"><script async src="https://www.googletagmanager.com/gtag/js?id=G-W0L24EMSQ5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W0L24EMSQ5")</script><link href=https://berkselvi.dev/css/custom.css rel=stylesheet></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=menu-trigger><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/tr>ana sayfa</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>türkçe ▾</li></ul><ul class="language-selector__more hidden"><li><a href=https://berkselvi.dev/>english</a></li><li><a href=https://berkselvi.dev/tr/>türkçe</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/tr>ana sayfa</a></li><hr><li><a href=https://berkselvi.dev/>english</a></li><li><a href=https://berkselvi.dev/tr/>türkçe</a></li></ul></nav></header><div class=content><div class=post><h4>Translations;</h4><a href=/posts/legacy-wcf-soap-to-modern-dotnet-migration/>Legacy WCF/SOAP to Modern .NET: Migration Without Compromise</a><h1 class=post-title><a href=https://berkselvi.dev/tr/posts/legacy-wcf-soap-to-modern-dotnet-migration/>Legacy WCF/SOAP&rsquo;tan Modern .NET&rsquo;e: Taviz Vermeden Migration</a></h1><div class=post-meta><span class=post-date>12 Aralık 2025
</span><span class=post-author>:: Berk Selvi</span>
<span class=post-reading-time>:: 8 min read (1631 words)</span></div><div class=post-content><div><h1 id=legacy-wcfsoaptan-modern-nete-taviz-vermeden-migration>Legacy WCF/SOAP&rsquo;tan Modern .NET&rsquo;e: Taviz Vermeden Migration<a href=#legacy-wcfsoaptan-modern-nete-taviz-vermeden-migration class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Mükemmel migration planını hazırladınız. Yol haritası harika görünüyor: O yaşlanmış, bitik monolitik .NET Framework 4.8 WCF uygulamasını alıp dönüştüreceksiniz. Arayüzü .NET 10 üzerinde şık, state tutmayan bir REST API olarak yeniden yazacak ve sonunda o eski IIS sunucusunu kapatacaksınız.</p><p>Planı paydaşlara sunuyorsunuz. İç ekipler alkışlarla tezahürat yapıyor. DevOps ekibi çoktan Dockerfile&rsquo;ları yazmaya başladı bile. Herkes çok heyecanlı.</p><p>Ve sonra o e-posta geliyor.</p><p>Büyük bir iş ortağının &ldquo;Eski Entegrasyonlar&rdquo; ekibinden veya belki de 2014&rsquo;ten beri yazılım güncellemesi almamış bir donanım cihazını yöneten bir tedarikçiden geliyor. Mesajları kibar ama net:</p><blockquote><p><em>&ldquo;Bir REST API tüketemeyiz. Sistemlerimiz bir SOAP gerektiriyor. WSDL&rsquo;in olduğu gibi kalmasına ihtiyacımız var. Eğer kontratı değiştirirseniz, size entegre olamayız.&rdquo;</em></p></blockquote><p>Aniden, migration planınız bir tuğla duvara çarpıyor. İki kötü seçenekle karşı karşıyasınız:</p><ol><li><strong>migrationü iptal etmek:</strong> Sadece tek bir arayüzü memnun etmek için tüm projeyi .NET Framework üzerinde tutmak.</li><li><strong>&ldquo;Sidecar&rdquo; Kabusu:</strong> Yeni sistemi .NET Core&rsquo;da kurmak, ancak sadece SOAP isteklerini yeni API&rsquo;ye proxy etmek için çalışan bir zombi .NET Framework sunucusunu ayakta tutmak.</li></ol><p>Ancak üçüncü bir seçenek daha var. Bir köprü.</p><p><strong>CoreWCF.</strong></p><p>CoreWCF, barındırma modelini, Dependency Injection ve performans özelliklerini modern .NET kullanarak tamamen yeniden yazarken, dış kontratı (SOAP) eski sistemle aynı tutmamıza olanak tanır.</p><p>Bu yazıda, bir <code>InvoiceService</code>&lsquo;i adım adım taşıyacağız. Ham bir uç noktayla (endpoint) başlayacak, onu modern yetkilendirme ile güvenli hale getirecek ve son olarak RESTful <code>ProblemDetails</code> ile SOAP Hataları (Faults) arasındaki boşluğu dolduran sofistike bir hata yönetimi uygulayacağız.</p><hr><h2 id=adım-1-migrationün-merhaba-dünyası>Adım 1: migrationün &ldquo;Merhaba Dünya"sı<a href=#adım-1-migrationün-merhaba-dünyası class=hanchor arialabel=Anchor>&#8983;</a></h2><p>İlk hedefimiz sadece ışıkları yakmak. <code>IInvoiceService</code> kontratını IIS yerine Kestrel web sunucusu kullanarak sunabileceğimizi kanıtlamak istiyoruz.</p><p>Henüz güvenlik veya hata yönetimi hakkında endişelenmiyoruz. Sadece XML&rsquo;in aktığını görmek istiyoruz.</p><h3 id=kontrat-ve-servis>Kontrat ve Servis<a href=#kontrat-ve-servis class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Servis Kontratımızı eski sistemdekiyle neredeyse tamamen aynı tutuyoruz. Tek fark, eski WCF uygulamasına kıyasla büyük bir performans kazancı sağlayan gerçek asenkron işlemeyi yani <code>Task&lt;T></code> yapısını benimsiyor olmamız. Ayrıca, Mediator desenine daha iyi uyması için mevcut istek ve yanıt modellerini birazcık yeniden adlandırdık.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// Sample.API.WCF/IInvoiceService.cs</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Sample.Business.Features.Invoices.CreateInvoice;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> Sample.API.WCF;
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>[ServiceContract]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IInvoiceService</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#a6e22e>    [OperationContract]</span>
</span></span><span style=display:flex><span>    Task&lt;CreateInvoiceCommandResponse&gt; CreateInvoice(CreateInvoiceCommand command);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Dikkat: Henüz burada hiçbir attribute yok, sadece saf mantık.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InvoiceService</span>(ISender mediator) : IInvoiceService
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;CreateInvoiceCommandResponse&gt; CreateInvoice(CreateInvoiceCommand command)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> mediator.Send(command);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=konfigürasyon-1-adım>Konfigürasyon (1. Adım)<a href=#konfigürasyon-1-adım class=hanchor arialabel=Anchor>&#8983;</a></h3><p>İşte en temel kurulum için <code>Program.cs</code>. Gereksiz her şeyi çıkarıyoruz.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// Program.cs - Adım 1: Temel WCF Barındırma</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Configuration;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Description;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Sample.API.WCF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Description;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> builder = WebApplication.CreateBuilder(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 1. CoreWCF temellerini DI container&#39;a ekle</span>
</span></span><span style=display:flex><span>builder.Services.AddTransient&lt;InvoiceService&gt;();
</span></span><span style=display:flex><span>builder.Services.AddServiceModelServices();
</span></span><span style=display:flex><span>builder.Services.AddServiceModelMetadata();
</span></span><span style=display:flex><span>services.AddSingleton&lt;IServiceBehavior, UseRequestHeadersForMetadataAddressBehavior&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 2. MediatR ve Servisimizi Kaydet</span>
</span></span><span style=display:flex><span>builder.Services.AddMediatR(cfg =&gt; cfg.RegisterServicesFromAssembly(<span style=color:#66d9ef>typeof</span>(Program).Assembly));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> app = builder.Build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 3. CoreWCF Middleware&#39;ini Yapılandır</span>
</span></span><span style=display:flex><span>app.UseServiceModel(serviceBuilder =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    serviceBuilder.AddService&lt;InvoiceService&gt;()
</span></span><span style=display:flex><span>    .AddServiceEndpoint&lt;InvoiceService, IInvoiceService&gt;(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> BasicHttpBinding(), <span style=color:#e6db74>&#34;/Services/InvoiceService.svc&#34;</span> <span style=color:#75715e>// Uç nokta URL&#39;si</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// İnatçı istemcinin referansını güncellemesi gerekirse diye WSDL üretimini etkinleştir</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> serviceMetadataBehavior = app.Services.GetRequiredService&lt;ServiceMetadataBehavior&gt;();
</span></span><span style=display:flex><span>    serviceMetadataBehavior.HttpGetEnabled = <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.Run();
</span></span></code></pre></div><p>Bu noktada, taşıma katmanında zafer kazandık. Entegratör <code>/Services/InvoiceService.svc</code> adresine gelebilir, bir XML/SOAP zarfı gönderebilir ve modern MediatR işleyicilerimiz iş kurallarını işler.</p><hr><h2 id=adım-2-yetkilendirme-authorization-ekleme>Adım 2: Yetkilendirme (Authorization) Ekleme<a href=#adım-2-yetkilendirme-authorization-ekleme class=hanchor arialabel=Anchor>&#8983;</a></h2><p>&ldquo;Sade&rdquo; servis çalışıyor ama tehlikeli. Eski WCF günlerinde, geliştiriciler çoğu zaman uç noktalara herhangi bir yetkilendirme desteği eklemezdi, güvenliği yapılandırmak güvenlik sertifikalarıyla uğraşmak demekti.</p><p>CoreWCF&rsquo;de, <strong>güvenlik sadece ASP.NET Core güvenliğidir</strong>.</p><p>Eğer REST API&rsquo;niz JWT Bearer tokenları veya Cookie Auth kullanıyorsa, CoreWCF uç noktalarınız da bunları kullanabilir. Tekerleği yeniden icat etmemize gerek yok. Servisimizi basitçe <code>[Authorize]</code> ile süslüyoruz.</p><h3 id=güncellenmiş-servis>Güncellenmiş Servis<a href=#güncellenmiş-servis class=hanchor arialabel=Anchor>&#8983;</a></h3><p><code>[Authorize]</code> ekliyoruz ve kullanıcı bağlamına erişebildiğimizi kanıtlamak için <code>IHttpContextAccessor</code> enjekte ediyoruz.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> MediatR;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Authorization;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Sample.Shared.Services.Interfaces;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> Sample.API.WCF;
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>[Authorize]</span> <span style=color:#75715e>// &lt;--- Sihirli kelime. Bu standart ASP.NET Core yetkilendirmesidir.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InvoiceService</span>(ISender mediator, IHttpContextAccessor httpContextAccessor) : IInvoiceService
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task&lt;Response&gt; CreateInvoice(CreateInvoiceCommand command)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> context = httpContextAccessor.HttpContext;
</span></span><span style=display:flex><span>        Console.WriteLine(context?.User.Identity?.Name);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> mediator.Send(command);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=konfigürasyon-2-adım>Konfigürasyon (2. Adım)<a href=#konfigürasyon-2-adım class=hanchor arialabel=Anchor>&#8983;</a></h3><p>ASP.NET Core Auth ara yazılımını (middleware), CoreWCF ara yazılımından <em>önce</em> katmanlamamız gerekiyor.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// Program.cs - Adım 2: Yetkilendirme Ekleme</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Configuration;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Description;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Sample.API.WCF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Authentication.JwtBearer; <span style=color:#75715e>// JWT varsayıyoruz</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> builder = WebApplication.CreateBuilder(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 1. Standart ASP.NET Core Kimlik Doğrulama Kurulumu</span>
</span></span><span style=display:flex><span>builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
</span></span><span style=display:flex><span>    .AddJwtBearer(JwtBearerDefaults.AuthenticationScheme, options =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        options.MapInboundClaims = <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        options.TokenValidationParameters = <span style=color:#66d9ef>new</span> TokenValidationParameters
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            ValidateIssuer = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            ValidateAudience = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            ValidateLifetime = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            ValidateIssuerSigningKey = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            ValidIssuer = configuration[<span style=color:#e6db74>&#34;Jwt:Issuer&#34;</span>],
</span></span><span style=display:flex><span>            ValidAudience = configuration[<span style=color:#e6db74>&#34;Jwt:Audience&#34;</span>],
</span></span><span style=display:flex><span>            IssuerSigningKey = <span style=color:#66d9ef>new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(configuration[<span style=color:#e6db74>&#34;Jwt:SecretKey&#34;</span>]!))
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder.Services.AddAuthorization(options =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    options.DefaultPolicy = <span style=color:#66d9ef>new</span> AuthorizationPolicyBuilder(JwtBearerDefaults.AuthenticationScheme)
</span></span><span style=display:flex><span>        .RequireAuthenticatedUser()
</span></span><span style=display:flex><span>        .Build();
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder.Services.AddTransient&lt;InvoiceService&gt;();
</span></span><span style=display:flex><span>builder.Services.AddServiceModelServices();
</span></span><span style=display:flex><span>builder.Services.AddServiceModelMetadata();
</span></span><span style=display:flex><span>services.AddSingleton&lt;IServiceBehavior, UseRequestHeadersForMetadataAddressBehavior&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder.Services.AddMediatR(cfg =&gt; cfg.RegisterServicesFromAssembly(<span style=color:#66d9ef>typeof</span>(Program).Assembly));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> app = builder.Build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 2. ÖNEMLİ: Auth middleware WCF middleware&#39;den önce çalışmalıdır</span>
</span></span><span style=display:flex><span>app.UseAuthentication();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.UseAuthorization();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.UseServiceModel(serviceBuilder =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    serviceBuilder.AddService&lt;InvoiceService&gt;()
</span></span><span style=display:flex><span>    .AddServiceEndpoint&lt;InvoiceService, IInvoiceService&gt;(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> BasicHttpBinding(), <span style=color:#e6db74>&#34;/Services/InvoiceService.svc&#34;</span> 
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> serviceMetadataBehavior = app.Services.GetRequiredService&lt;ServiceMetadataBehavior&gt;();
</span></span><span style=display:flex><span>    serviceMetadataBehavior.HttpGetEnabled = <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.Run();
</span></span></code></pre></div><p>Şimdi, eğer entegratör geçerli bir standart HTTP <code>Authorization: Bearer</code> header&rsquo;ı olmadan bir istek gönderirse, CoreWCF bunu kodumuza daha ulaşmadan 401 ile reddedecektir. Elbette müşterimizin istek yapmadan önce ek bir adım uygulaması gerekir ancak authn & authz olmadan herhangi bir uygulama saldırılara açık olacaktır.</p><hr><h2 id=adım-3-evrensel-çevirmen-birleşik-hata-yönetimi>Adım 3: Evrensel Çevirmen (Birleşik Hata Yönetimi)<a href=#adım-3-evrensel-çevirmen-birleşik-hata-yönetimi class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Hikayenin en zor kısmı burası.</p><p>Modern bir REST API&rsquo;de, bir şeyler ters gittiğinde (örneğin &ldquo;Fatura bulunamadı&rdquo;), özel bir <code>BadRequestException</code> fırlatırız ve bir JSON <code>ProblemDetails</code> (RFC 7807) yanıtı döndürürüz.</p><p>WCF&rsquo;de ise, XML içine sarılmış bir <code>FaultException</code> döndürmemiz beklenir.</p><p>Eğer bunu yönetmezsek, güzelim <code>ValidationException</code>&lsquo;ımız servisi çökertecek ve istemciye genel, çirkin bir &ldquo;Internal Server Error&rdquo; dönecektir. Modern Exception&rsquo;larımızı yakalayan ve onları hala tüm zengin verileri (doğrulama hata alanları gibi) içeren SOAP Hatalarına (Faults) çeviren bir tercümana ihtiyacımız var.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Diagnostics;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Xml.Linq;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Channels;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Dispatcher;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Sample.Domain.Constants;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Sample.Domain.Exceptions;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.AspNetCore.Mvc;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.Localization;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> Sample.API.Filters;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// Exception&#39;ları yakalayan ve ProblemDetails&#39;i SOAP Fault olarak döndüren CoreWCF Hata İşleyicisi.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// Bu, modern Exception tanımları ile eski SOAP hataları arasında bir köprü görevi görür.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// &lt;/summary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExceptionHandlerErrorHandler</span> : IErrorHandler
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>string</span> HttpRfcBadRequest = <span style=color:#e6db74>&#34;https://tools.ietf.org/html/rfc7231#section-6.5.1&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>string</span> ProblemDetailsNamespace = <span style=color:#e6db74>&#34;urn:ietf:rfc:7807&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> ILogger&lt;ExceptionHandlerErrorHandler&gt; _logger;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IHttpContextAccessor _httpContextAccessor;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IStringLocalizer&lt;ExceptionHandleMiddleware&gt; _localizer;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> Dictionary&lt;Type, Func&lt;Exception, ProblemDetails&gt;&gt; _exceptionHandlers;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ExceptionHandlerErrorHandler(
</span></span><span style=display:flex><span>        ILogger&lt;ExceptionHandlerErrorHandler&gt; logger,
</span></span><span style=display:flex><span>        IHttpContextAccessor httpContextAccessor,
</span></span><span style=display:flex><span>        IStringLocalizer&lt;ExceptionHandleMiddleware&gt; localizer)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _logger = logger;
</span></span><span style=display:flex><span>        _httpContextAccessor = httpContextAccessor;
</span></span><span style=display:flex><span>        _localizer = localizer;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Domain exception&#39;larını belirli ProblemDetails işleyicilerine eşle</span>
</span></span><span style=display:flex><span>        _exceptionHandlers = <span style=color:#66d9ef>new</span>()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            { <span style=color:#66d9ef>typeof</span>(BadRequestException), HandleBadRequestException },
</span></span><span style=display:flex><span>            <span style=color:#75715e>// İstediğiniz kadar ekleyin</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> HandleError(Exception error)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Hatayı işlediğimizi ve oturumun hatalı olmadığını belirtmek için true döndür</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> ProvideFault(Exception error, MessageVersion version, <span style=color:#66d9ef>ref</span> Message fault)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1. Exception&#39;ı ProblemDetails&#39;e dönüştür</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> problemDetails = CreateProblemDetails(error);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2. ProblemDetails&#39;i SOAP Body için XML Elementine dönüştür</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> problemDetailsElement = TransformToXml(problemDetails);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3. Problem detaylarını içeren bir FaultException oluştur</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> faultException = <span style=color:#66d9ef>new</span> FaultException&lt;XElement&gt;(
</span></span><span style=display:flex><span>            problemDetailsElement,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> FaultReason(problemDetails.Title ?? <span style=color:#e6db74>&#34;An error occurred&#34;</span>),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> FaultCode(GetFaultCodeFromStatus(problemDetails.Status ?? <span style=color:#ae81ff>500</span>)),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ProblemDetails&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> messageFault = faultException.CreateMessageFault();
</span></span><span style=display:flex><span>        fault = Message.CreateMessage(version, messageFault, faultException.Action);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4. Temel HTTP durum kodunu ayarla (izleme/gözlemlenebilirlik için önemli)</span>
</span></span><span style=display:flex><span>        SetHttpStatusCode(problemDetails.Status ?? StatusCodes.Status500InternalServerError);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProblemDetails CreateProblemDetails(Exception exception)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> exceptionType = exception.GetType();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (_exceptionHandlers.TryGetValue(exceptionType, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>var</span> handler))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            _logger.LogWarning(<span style=color:#e6db74>&#34;Handled Exception {ExceptionMessage}: Time {Time}&#34;</span>, exception.Message, DateTime.UtcNow);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> pd = handler(exception);
</span></span><span style=display:flex><span>            EnrichProblemDetails(pd);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> pd;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _logger.LogError(exception, <span style=color:#e6db74>&#34;Unhandled Exception: Time {Time}&#34;</span>, DateTime.UtcNow);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> unknownPd = HandleUnknownException(exception);
</span></span><span style=display:flex><span>        EnrichProblemDetails(unknownPd);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> unknownPd;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// --- Özel Exception İşleyicileri ---</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProblemDetails HandleBadRequestException(Exception ex)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> exception = (BadRequestException)ex;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ProblemDetails
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Status = StatusCodes.Status400BadRequest,
</span></span><span style=display:flex><span>            Type = HttpRfcBadRequest,
</span></span><span style=display:flex><span>            Title = _localizer[Localized.BadRequestExceptionTitle],
</span></span><span style=display:flex><span>            Detail = _localizer[exception.LocalizedMessage, exception.Arguments]
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProblemDetails HandleValidationException(Exception ex)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> exception = (ValidationException)ex;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ValidationProblemDetails(exception.Errors)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Status = StatusCodes.Status400BadRequest,
</span></span><span style=display:flex><span>            Type = HttpRfcBadRequest,
</span></span><span style=display:flex><span>            Title = _localizer[Localized.ValidationExceptionTitle]
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> ProblemDetails HandleUnknownException(Exception ex)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ProblemDetails
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Status = StatusCodes.Status500InternalServerError,
</span></span><span style=display:flex><span>            Type = HttpRfcInternalError,
</span></span><span style=display:flex><span>            Title = <span style=color:#e6db74>&#34;Beklenmeyen bir hata oluştu&#34;</span>,
</span></span><span style=display:flex><span>            Detail = ex.Message
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// --- Yardımcılar ---</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> EnrichProblemDetails(ProblemDetails result)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Hata raporlaması için dağıtık izleme (distributed tracing) ID&#39;lerini ekle</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> correlation = AsyncStorage&lt;Correlation&gt;.Retrieve();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (correlation <span style=color:#66d9ef>is</span> not <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            result.Extensions.Add(<span style=color:#e6db74>&#34;correlationId&#34;</span>, correlation.Id);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> traceId = Activity.Current?.Id;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (traceId <span style=color:#66d9ef>is</span> not <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            result.Extensions.Add(nameof(traceId), traceId);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> XElement TransformToXml(ProblemDetails problemDetails)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> ns = XNamespace.Get(ProblemDetailsNamespace);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> element = <span style=color:#66d9ef>new</span> XElement(ns + <span style=color:#e6db74>&#34;problem&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> XElement(ns + <span style=color:#e6db74>&#34;type&#34;</span>, problemDetails.Type),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> XElement(ns + <span style=color:#e6db74>&#34;title&#34;</span>, problemDetails.Title),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> XElement(ns + <span style=color:#e6db74>&#34;status&#34;</span>, problemDetails.Status),
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> XElement(ns + <span style=color:#e6db74>&#34;detail&#34;</span>, problemDetails.Detail ?? <span style=color:#66d9ef>string</span>.Empty));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> extension <span style=color:#66d9ef>in</span> problemDetails.Extensions)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            element.Add(<span style=color:#66d9ef>new</span> XElement(ns + extension.Key, extension.Value?.ToString() ?? <span style=color:#66d9ef>string</span>.Empty));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (problemDetails <span style=color:#66d9ef>is</span> ValidationProblemDetails validationProblemDetails &amp;&amp;
</span></span><span style=display:flex><span>            validationProblemDetails.Errors.Count &gt; <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> errorsElement = <span style=color:#66d9ef>new</span> XElement(ns + <span style=color:#e6db74>&#34;errors&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> error <span style=color:#66d9ef>in</span> validationProblemDetails.Errors)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>var</span> errorElement = <span style=color:#66d9ef>new</span> XElement(ns + <span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#66d9ef>new</span> XAttribute(<span style=color:#e6db74>&#34;field&#34;</span>, error.Key));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> message <span style=color:#66d9ef>in</span> error.Value)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    errorElement.Add(<span style=color:#66d9ef>new</span> XElement(ns + <span style=color:#e6db74>&#34;message&#34;</span>, message));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                errorsElement.Add(errorElement);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            element.Add(errorsElement);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> element;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>string</span> GetFaultCodeFromStatus(<span style=color:#66d9ef>int</span> status)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> status <span style=color:#66d9ef>switch</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>400</span> =&gt; <span style=color:#e6db74>&#34;BadRequest&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>401</span> =&gt; <span style=color:#e6db74>&#34;Unauthorized&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>403</span> =&gt; <span style=color:#e6db74>&#34;Forbidden&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>404</span> =&gt; <span style=color:#e6db74>&#34;NotFound&#34;</span>,
</span></span><span style=display:flex><span>            _ =&gt; <span style=color:#e6db74>&#34;InternalServerError&#34;</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> SetHttpStatusCode(<span style=color:#66d9ef>int</span> statusCode)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> httpContext = _httpContextAccessor.HttpContext;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (httpContext <span style=color:#66d9ef>is</span> not <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            httpContext.Response.StatusCode = statusCode;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=konfigürasyon-3-adım>Konfigürasyon (3. Adım)<a href=#konfigürasyon-3-adım class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Bu hata işleyicisini bir <code>IServiceBehavior</code> olarak bağlamamız gerekiyor. Bu, servise yapılan her bir çağrı için geçerli olmasını sağlar.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// Program.cs - Adım 3: Hata Yönetimi ile Üretime Hazır</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Channels;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Configuration;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Description;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> CoreWCF.Dispatcher;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Sample.API.Filters; <span style=color:#75715e>// ErrorHandler&#39;ımızın olduğu yer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Sample.API.WCF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> Microsoft.Extensions.DependencyInjection.Extensions;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> builder = WebApplication.CreateBuilder(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
</span></span><span style=display:flex><span>    .AddJwtBearer(JwtBearerDefaults.AuthenticationScheme, options =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        options.MapInboundClaims = <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        options.TokenValidationParameters = <span style=color:#66d9ef>new</span> TokenValidationParameters
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            ValidateIssuer = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            ValidateAudience = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            ValidateLifetime = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            ValidateIssuerSigningKey = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            ValidIssuer = configuration[<span style=color:#e6db74>&#34;Jwt:Issuer&#34;</span>],
</span></span><span style=display:flex><span>            ValidAudience = configuration[<span style=color:#e6db74>&#34;Jwt:Audience&#34;</span>],
</span></span><span style=display:flex><span>            IssuerSigningKey = <span style=color:#66d9ef>new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(configuration[<span style=color:#e6db74>&#34;Jwt:SecretKey&#34;</span>]!))
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder.Services.AddAuthorization(options =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    options.DefaultPolicy = <span style=color:#66d9ef>new</span> AuthorizationPolicyBuilder(JwtBearerDefaults.AuthenticationScheme)
</span></span><span style=display:flex><span>        .RequireAuthenticatedUser()
</span></span><span style=display:flex><span>        .Build();
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>builder.Services.AddTransient&lt;InvoiceService&gt;();
</span></span><span style=display:flex><span>builder.Services.AddServiceModelServices();
</span></span><span style=display:flex><span>builder.Services.AddServiceModelMetadata();
</span></span><span style=display:flex><span>builder.Services.AddSingleton&lt;IServiceBehavior, UseRequestHeadersForMetadataAddressBehavior&gt;();
</span></span><span style=display:flex><span>builder.Services.AddSingleton&lt;IErrorHandler, ExceptionHandlerErrorHandler&gt;(); <span style=color:#75715e>// Bu satırların</span>
</span></span><span style=display:flex><span>builder.Services.AddSingleton&lt;IServiceBehavior, ExceptionHandlerServiceBehaviour&gt;(); <span style=color:#75715e>// eklenmesi gerek.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> app = builder.Build();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.UseAuthentication();
</span></span><span style=display:flex><span>app.UseAuthorization();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.UseServiceModel(serviceBuilder =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    serviceBuilder.AddService&lt;InvoiceService&gt;()
</span></span><span style=display:flex><span>    .AddServiceEndpoint&lt;InvoiceService, IInvoiceService&gt;(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> BasicHttpBinding(), <span style=color:#e6db74>&#34;/Services/InvoiceService.svc&#34;</span> 
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> serviceMetadataBehavior = app.Services.GetRequiredService&lt;ServiceMetadataBehavior&gt;();
</span></span><span style=display:flex><span>    serviceMetadataBehavior.HttpGetEnabled = <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.Run();
</span></span></code></pre></div><h3 id=mutlu-son>Mutlu Son<a href=#mutlu-son class=hanchor arialabel=Anchor>&#8983;</a></h3><ol start=3><li><p>Adım itibarıyla dikkate değer bir şey başardık:</p></li><li><p><strong>Entegratör</strong> mutlu çünkü hala <code>/Services/InvoiceService.svc</code> adresine SOAP istekleri gönderiyorlar. Entegrasyon desenlerini değiştirmek zorunda kalmadılar.</p></li><li><p><strong>Geliştirici</strong> mutlu çünkü <code>InvoiceService</code> tertemiz. <code>MediatR</code> kullanıyor. İş mantığını kirleten <code>try/catch</code> blokları yok. Güvenlik için <code>[Authorize]</code> kullanıyor.</p></li><li><p><strong>Operasyon Ekibi</strong> mutlu çünkü loglar, istek bir REST istemcisinden de gelse SOAP istemcisinden de gelse tutarlı <code>ProblemDetails</code> yapılarını gösteriyor.</p></li></ol><p>Sadece kodu &ldquo;port&rdquo; etmedik; etrafındaki ekosistemi modernize ettik ve WCF arayüzünü bir pranga yerine bir uyumluluk katmanı olarak bıraktık.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://berkselvi.dev/tr/posts/grpc-in-net-microservices-comparison-with-rest/><span class=button__text>.NET Mikroservislerinde gRPC: REST ile Karşılaştırma</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=berkslv/berkselvi.dev issue-term=title theme=dark-blue crossorigin=anonymous async></script></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Made by Berk Selvi.<br>Bu websitesi <a href=https://github.com/berkslv/berkselvi.dev target=_blank>open source</a> olarak yayınlanmıştır.</span></div></div></footer><script src=https://berkselvi.dev/assets/main.js></script><script src=https://berkselvi.dev/assets/prism.js></script><script src=https://berkselvi.dev/assets/languageSelector.js></script></div></body></html>