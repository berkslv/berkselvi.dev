<!doctype html><html lang=en><head><title>Achieving Zero Downtime: Azure App Service Deployment using Azure DevOps and Deployment Slots :: Berk Selvi | Software Developer</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When deploying our application, which runs as a single instance in Azure App Service, using Azure DevOps pipelines, there will most likely be a few seconds of downtime. Because the application…"><meta name=keywords content="ci/cd,azure devops,azure app service,.NET,azure"><meta name=robots content="noodp"><link rel=canonical href=https://berkselvi.dev/posts/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/><link rel=stylesheet href=https://berkselvi.dev/assets/style.css><link rel=stylesheet href=https://berkselvi.dev/assets/green.css><link rel=canonical href=https://berkselvi.dev/posts/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/><link rel=apple-touch-icon sizes=57x57 href=/icon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/icon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/icon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/icon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/icon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/icon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/icon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/icon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/icon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/icon/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/icon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/icon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/icon/favicon-16x16.png><link rel=manifest href=/icon/manifest.json><meta name=msapplication-TileColor content="#1D1E28"><meta name=msapplication-TileImage content="/icon/ms-icon-144x144.png"><meta name=theme-color content="#1D1E28"><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="berkslv"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Achieving Zero Downtime: Azure App Service Deployment using Azure DevOps and Deployment Slots"><meta property="og:description" content="When deploying our application, which runs as a single instance in Azure App Service, using Azure DevOps pipelines, there will most likely be a few seconds of downtime. Because the application…"><meta property="og:url" content="https://berkselvi.dev/posts/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/"><meta property="og:site_name" content="Berk Selvi | Software Developer"><meta property="og:image" content="https://berkselvi.dev/icon/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-11-21 00:00:00 +0300 +0300"><link href=https://berkselvi.dev/css/custom.css rel=stylesheet></head><body class=green><div class="container center headings--one-size"><header class=header><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>home</a></li><div class=spacer></div><ul class=language-selector><ul class=language-selector-current><li>english ▾</li></ul><ul class="language-selector__more hidden"><li><a href=https://berkselvi.dev/>english</a></li><li><a href=https://berkselvi.dev/tr/>türkçe</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>home</a></li><hr><li><a href=https://berkselvi.dev/>english</a></li><li><a href=https://berkselvi.dev/tr/>türkçe</a></li></ul></nav></header><div class=content><div class=post><h4>For turkish translation;</h4><a href=/tr/posts/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/>Zero downtime ile Deployment: Azure DevOps Deployment Slots Kullanarak Azure App Service Deployment işlemi ()</a><h1 class=post-title><a href=https://berkselvi.dev/posts/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/>Achieving Zero Downtime: Azure App Service Deployment using Azure DevOps and Deployment Slots</a></h1><div class=post-meta><span class=post-date>November 21, 2023
</span><span class=post-author>:: Berk Selvi</span>
<span class=post-reading-time>:: 7 min read (1379 words)</span></div><div class=post-content><div><p>Hello! When deploying our application, which runs as a single instance in Azure App Service, using Azure DevOps pipelines, there will most likely be a few seconds of downtime. Because the application running as a single instance will need to be restarted to update it with a new version. In a worst case scenario, if an error occurs in the transition of our application versions, downtime will be extended due to rollback.</p><p>We can use the deployment slots feature to solve this problem specifically for the app service. With this feature, 2 different instances, usually staging and production applications, are running in a single app service plan as a separate instances, and when switching to production, the swap operation is managed by the app service and no downtime is experienced.</p><p>In this post, we will create a very simple Dotnet Web API project, host it in the Azure DevOps repository, deploy it to Azure App Service by creating a CI/CD pipeline with the Azure DevOps pipeline, and perform zero downtime deployment with the deployment slots feature. We will complete the entire process in 5 steps as follows. Let’s begin.</p><ol><li>Creating the application</li><li>Azure DevOps Repo</li><li>Azure DevOps build pipeline</li><li>Azure App service</li><li>Zero downtime testing</li></ol><p>## Creating the application</p><p>We create a simple Dotnet Web API project to deploy. To do this, we create our project with the following commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir backend  
</span></span><span style=display:flex><span>cd ./backend  
</span></span><span style=display:flex><span>dotnet new sln -n Slot  
</span></span><span style=display:flex><span>dotnet new webapi -n Slot.API  
</span></span><span style=display:flex><span>dotnet sln add ./Slot.API/
</span></span></code></pre></div><p>We update the <em>profiles.http</em> property in the <em>properties/launchSetting.json</em> file as follows. Here we only updated the <em>applicationUrl</em> and <em>launchBrowser</em> properties.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// ...  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#e6db74>&#34;profiles&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;http&#34;</span>: {  
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;commandName&#34;</span>: <span style=color:#e6db74>&#34;Project&#34;</span>,  
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;dotnetRunMessages&#34;</span>: <span style=color:#66d9ef>true</span>,  
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;launchBrowser&#34;</span>: <span style=color:#66d9ef>false</span>,  
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;launchUrl&#34;</span>: <span style=color:#e6db74>&#34;swagger&#34;</span>,  
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;applicationUrl&#34;</span>: <span style=color:#e6db74>&#34;http://localhost:5050&#34;</span>,  
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;environmentVariables&#34;</span>: {  
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;ASPNETCORE_ENVIRONMENT&#34;</span>: <span style=color:#e6db74>&#34;Development&#34;</span>  
</span></span><span style=display:flex><span>      }  
</span></span><span style=display:flex><span>    },  
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span></code></pre></div><p>By making the following update on Program.cs, we will test that the application is accessible and can meet the requests made to the /health endpoint. If you are using a database in your application, you can also test whether there is a problem accessing the database with <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.entityframeworkcorehealthchecksbuilderextensions.adddbcontextcheck?view=dotnet-plat-ext-8.0">AddDbContextCheck</a> method.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#66d9ef>var</span> builder = WebApplication.CreateBuilder(args);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// ...  </span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>builder.Services.AddHealthChecks();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> app = builder.Build();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// ...  </span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// app.UseHttpsRedirection();  </span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>app.MapControllers();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>app.UseHealthChecks(<span style=color:#e6db74>&#34;/health&#34;</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>app.Run();
</span></span></code></pre></div><p>That’s it for our application! Now we can access the localhost:5050/health endpoint by running</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd ./Slot.API  
</span></span><span style=display:flex><span>dotnet run  
</span></span><span style=display:flex><span>curl -4 http://localhost:5050/health  
</span></span><span style=display:flex><span><span style=color:#75715e># Healthy</span>
</span></span></code></pre></div><p>Later, we will use Docker to deploy our application, so we put our Dockerfile file in the same directory as our sln file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#75715e># Build Stage  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/dotnet/aspnet:7.0-alpine AS base  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Publish Stage  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mcr.microsoft.com/dotnet/sdk:7.0-alpine AS build  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;Slot.API/Slot.API.csproj&#34;</span>, <span style=color:#e6db74>&#34;Slot.API/&#34;</span><span style=color:#f92672>]</span>  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> dotnet restore <span style=color:#e6db74>&#34;Slot.API/Slot.API.csproj&#34;</span>  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> &#34;/Slot.API&#34;  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> dotnet build <span style=color:#e6db74>&#34;Slot.API.csproj&#34;</span> -c Release -o /app/build  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> build AS publish  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> dotnet publish <span style=color:#e6db74>&#34;Slot.API.csproj&#34;</span> -c Release -o /app/publish /p:UseAppHost<span style=color:#f92672>=</span>false  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base AS final  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app  </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>publish /app/publish .  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> ASPNETCORE_URLS<span style=color:#f92672>=</span>http://*:8080  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> ASPNETCORE_ENVIRONMENT<span style=color:#f92672>=</span>Production  
</span></span><span style=display:flex><span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;dotnet&#34;</span>, <span style=color:#e6db74>&#34;Slot.API.dll&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>We can use the following two commands to ensure that we can successfully build the image and run the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t deployment-slots-demo .  
</span></span><span style=display:flex><span>docker run -it -p 80:8080 deployment-slots-demo -n deployment-slots-demo-container
</span></span></code></pre></div><h2 id=verify-that-the-application-is-up>Verify that the application is up<a href=#verify-that-the-application-is-up class=hanchor arialabel=Anchor>&#8983;</a></h2><p>After creating our application with the health check feature in the previous step, we can verify that the application is accessible by making a request to this endpoint every second. This way, we will verify that it is accessible when deployed to Azure.</p><p>In this section, we will write a simple Node.js script to verify that the application can be accessed by making requests every second. We use the following commands for this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir health-check  
</span></span><span style=display:flex><span>npm init -y  
</span></span><span style=display:flex><span>touch index.js  
</span></span><span style=display:flex><span>npm install node-fetch
</span></span></code></pre></div><p>We add the following script to the package.json file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// ...  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>&#34;scripts&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {  
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;node index.js&#34;</span>  
</span></span><span style=display:flex><span>}<span style=color:#960050;background-color:#1e0010>,</span>  
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;type&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;module&#34;</span><span style=color:#960050;background-color:#1e0010>,</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span></code></pre></div><p>We can create our index.js file as follows. With this code, we will make a request to the given url every 50 milisecond and write the response to the console.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fetch</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;node-fetch&#34;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>check</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>url</span>) =&gt; {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>url</span>, {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET&#34;</span>,  
</span></span><span style=display:flex><span>    });  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>text</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>result</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;Healthy&#34;</span>) {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74> result is not OK`</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74> error is </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);  
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>};  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>(() =&gt; {  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setInterval</span>(() =&gt; {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>check</span>(<span style=color:#e6db74>&#34;http://localhost:5050/health&#34;</span>);  
</span></span><span style=display:flex><span>  }, <span style=color:#ae81ff>50</span>);  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setInterval</span>(() =&gt; {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>check</span>(<span style=color:#e6db74>&#34;http://localhost:5050/health&#34;</span>);  
</span></span><span style=display:flex><span>  }, <span style=color:#ae81ff>50</span>);  
</span></span><span style=display:flex><span>})();
</span></span></code></pre></div><p>If you do not turn off the UseHttpsRedirection middleware in our API project, you may receive an invalid SSL certificate error. You can fix this as follows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fetch</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;node-fetch&#34;</span>;  
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>https</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;https&#34;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>httpsAgent</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>https</span>.<span style=color:#a6e22e>Agent</span>({  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rejectUnauthorized</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,  
</span></span><span style=display:flex><span>});  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>check</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>url</span>) =&gt; {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>url</span>, {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET&#34;</span>,  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>agent</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>httpsAgent</span>,  
</span></span><span style=display:flex><span>    });  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>text</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>result</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;Healthy&#34;</span>) {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74> result is not OK`</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74> error is </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);  
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>};  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>(() =&gt; {  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setInterval</span>(() =&gt; {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>check</span>(<span style=color:#e6db74>&#34;https://localhost:5051/health&#34;</span>);  
</span></span><span style=display:flex><span>  }, <span style=color:#ae81ff>50</span>);  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setInterval</span>(() =&gt; {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>check</span>(<span style=color:#e6db74>&#34;https://localhost:5051/health&#34;</span>);  
</span></span><span style=display:flex><span>  }, <span style=color:#ae81ff>50</span>);  
</span></span><span style=display:flex><span>})();
</span></span></code></pre></div><h2 id=azure-devops-repo>Azure DevOps Repo<a href=#azure-devops-repo class=hanchor arialabel=Anchor>&#8983;</a></h2><p>We log into our Azure DevOps account and create a new repo as follows.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-1.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-2.webp alt="Azure deployment" loading=lazy><p>We will clone this repo to our computer, move the code that we write into this repo folder and push the codes to origin.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-3.webp alt="Azure deployment" loading=lazy><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git add .  
</span></span><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;inital commit&#34;</span>  
</span></span><span style=display:flex><span>git push origin
</span></span></code></pre></div><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-4.webp alt="Azure deployment" loading=lazy><h2 id=azure-devops-build-pipeline>Azure DevOps build pipeline<a href=#azure-devops-build-pipeline class=hanchor arialabel=Anchor>&#8983;</a></h2><p>On the Pipeline screen, we click on the New pipeline button from the top right. Then, we build the docker file and push it to Azure Container Registry by following the steps below.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-5.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-6.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-7.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-8.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-9.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-10.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-11.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-12.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-13.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-14.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-15.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-16.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-17.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-18.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-19.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-20.webp alt="Azure deployment" loading=lazy><p>Now we check that our image deployment in Azure Container Registry is successful.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-21.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-22.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-23.webp alt="Azure deployment" loading=lazy><p>As we can see, when the pipeline is run, the docker image has been successfully created in the Azure Container Registry and is waiting to be used. After these settings, a new docker image will be created by triggering every change made in the /backend directory on the main branch.</p><h2 id=azure-app-service>Azure App service<a href=#azure-app-service class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Azure App service allows us to deploy web applications with security, load balancing, autoscaling managed by Azure itself. We can create a new app service via the Azure app services screen as follows.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-24.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-25.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-26.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-27.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-28.webp alt="Azure deployment" loading=lazy><p>After creating the app service, you may need to update the Container Registry password from the configuration tab.</p><p>## Azure DevOps release pipeline</p><p>With the release pipeline, we deploy to the App service using the Docker image produced by the build pipeline and publish our application.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-29.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-30.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-31.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-32.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-33.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-34.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-35.webp alt="Azure deployment" loading=lazy><p>By going into staging deployment, we get deployment for our staging version and restart our app service to ensure that the docker image change we made goes live.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-36.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-37.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-38.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-39.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-40.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-41.webp alt="Azure deployment" loading=lazy><p>In our production step, we do not take a deployment to the app service, instead we perform the swap operation with staging and in this way, we start running our application running in staging in production without experiencing any downtime.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-42.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-43.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-44.webp alt="Azure deployment" loading=lazy><br><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-45.webp alt="Azure deployment" loading=lazy><p>From now on, any changes made to the main branch will first run the build pipeline (CI), then the deployment pipeline (CD), and deployment will be made to the staging environment. If you want to switch to Production, Production deployment must be triggered manually from the release screen.</p><img src=/img/achieving-zero-downtime-azure-app-service-deployment-using-azure-devops-and-deployment-slots/azure-deployment-46.webp alt="Azure deployment" loading=lazy><h2 id=zero-downtime-testing>Zero downtime testing<a href=#zero-downtime-testing class=hanchor arialabel=Anchor>&#8983;</a></h2><p>We have successfully created a pipeline for our application, from now on we will need to test whether there is any downtime during deployment. For this, I update our <em>health-check/index.js</em> file as follows and run the application with the npm run start command and trigger the pipeline. And then I complete the deployment process without receiving any error messages on the console, that is, without any downtime!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fetch</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;node-fetch&#34;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>check</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>url</span>) =&gt; {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>url</span>, {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;GET&#34;</span>,  
</span></span><span style=display:flex><span>    });  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>text</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>result</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;Healthy&#34;</span>) {  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74> result is not OK`</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>, </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74> error is </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);  
</span></span><span style=display:flex><span>  }  
</span></span><span style=display:flex><span>};  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>(() =&gt; {  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setInterval</span>(() =&gt; {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>check</span>(<span style=color:#e6db74>&#34;https://deployment-slot-demo.azurewebsites.net/health&#34;</span>);  
</span></span><span style=display:flex><span>  }, <span style=color:#ae81ff>50</span>);  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setInterval</span>(() =&gt; {  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>check</span>(<span style=color:#e6db74>&#34;https://deployment-slot-demo-staging.azurewebsites.net/health&#34;</span>);  
</span></span><span style=display:flex><span>  }, <span style=color:#ae81ff>50</span>);  
</span></span><span style=display:flex><span>})();
</span></span></code></pre></div><p>If we try a similar process in an app service deployment that does not implement deployment slots, we will receive an error as follows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>2023-11-14T12:28:39.506Z, <span style=color:#f92672>[</span>some-url<span style=color:#f92672>]</span>/health error is request to <span style=color:#f92672>[</span>some-url<span style=color:#f92672>]</span>/health failed, reason: connect ETIMEDOUT 100.100.100.100:443
</span></span></code></pre></div><hr><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Thank you for reading 🎉 Don&rsquo;t miss out on the latest updates and insights in the world of software development. Follow me on <a href=https://x.com/berkslv>@berkslv</a> to stay connected and join the conversation</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://berkselvi.dev/posts/how-to-use-ocelot-and-keycloak-together-to-secure-microservices-from-api-gateway/><span class=button__icon>←</span>
<span class=button__text>How to use Ocelot and Keycloak together to secure Microservices from API Gateway</span>
</a></span><span class="button next"><a href=https://berkselvi.dev/posts/how-to-secure-dotnet-vue-application-with-keycloak/><span class=button__text>How to Secure Dotnet & Vue.js Application with Keycloak</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=berkslv/berkselvi.dev issue-term=title theme=dark-blue crossorigin=anonymous async></script></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Made by Berk Selvi</span></div></div></footer><script src=https://berkselvi.dev/assets/main.js></script><script src=https://berkselvi.dev/assets/prism.js></script><script src=https://berkselvi.dev/assets/languageSelector.js></script></div></body></html>